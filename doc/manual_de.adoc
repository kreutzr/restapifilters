= RestApiFilters - Version 0.0.0-SNAPSHOT
:encoding: utf-8
:lang: de
:toc: left
:toclevels: 5

image::img/restapifilters-logo_320x160.png[RestApiFilters]

== Was bietet RestApiFilters?

RestApiFilters stellt Filter bereit, um in Tests oder auch in Produktion Kennzahlen zu Services und deren Aufrufverhalten zu liefern.

== Erforderliche Infrastruktur

=== Java
RestApiFilters benötigt Java in einer Version 11 oder höher.

== DurationServletFilter

Der DurationServletFilter misst die Gesamtausführungsdauer eines Aufrufs und ggfs. die der Aufrufe, die während des Aufrufs vom Service selbst initiiert werden.

[NOTE]
====
Damit interne Serviceaufrufe korrekt aufgenommen werden können, muss ein eingehender Header-Wert an den ausgehenden internen Aufruf im Request weitergegeben werden. *(Service A -> Service B und Service C -> Service D)*

Der vom internen Aufruf zurückgegebene Response-Header-Wert muss dem nachfolgenden internen Aufruf im Request weitergereicht werden. *(Service A -> Service C)*

Dieses Weiterreichen wird solange fortgesetzt bis kein weiterer interner Aufruf mehr erfolgt. In diesem Fall wird der zuletzt empfangene Response-Header-Wert im Response des aktuellen Service selbst als Response-Header-Wert übergeben. *(Service D -> Service C, Service C -> Service A -> und Service A -> Client)*

image::img/invocation-example.png[]
====

Die Aufrufdaten werden als JSON-Struktur in einem konfigurierbaren Response-Header zurück geliefert. Der Name des Headers is per Default `x-duration`.

.Beispiel `x-duration` JSON-Struktur
====
[source,json]
----
{
  "begin":    "2025-08-28T20:21:15.000000000Z", <1>
  "end":      "2025-08-28T20:21:25.000000000Z", <2>
  "duration": ""PT10S" <3>,
  "trace": [ <4>
    {
      "url":      "https://my-server:8080/my-app/my-endpoint", <5>
      "begin":    "2025-08-28T20:21:15.000000000Z",
      "end":      "2025-08-28T20:21:25.000000000Z",
      "duration": "PT10S"
    },
    {
      "url":      "https://my-server:8080/my-app/my-inner-endpoint",
      "begin":    "2025-08-28T20:21:17.000000000Z",
      "end":      "2025-08-28T20:21:19.000000000Z",
      "duration": "PT2S"
    }
  ],
  "traceRemovalCount": 1 <6>
}
----
<1> Der Zeitpunkt zu dem der Request einging (gemäß link:https://de.wikipedia.org/wiki/ISO_8601[ISO_8601]).
<2> Der Zeitpunkt zu dem der Reponse versandt wurde (gemäß link:https://de.wikipedia.org/wiki/ISO_8601[ISO_8601]).
<3> Die Differenzdauer zwischen `end` und `begin` (gemäß link:https://de.wikipedia.org/wiki/ISO_8601[ISO_8601]).
<4> Eine Liste mit allen ausgeführten Requests - inklusive eventuell intern ausgelöster Requests. Die Liste ist sortiert nach dem Zeitstempel des Request-Eingangs.
<5> Die URL der jeweiligen Requests.
<6> Ein optionaler Indikator, der angibt, wie viele interne Requests nicht in der `trace`-Liste aufgeführt wurden, da andernfalls die Maximallänge des Header-Werts überschritten worden wäre.
====

=== Konfiguration

Der Filter kann wie folgt konfiguriert werden:

==== web.xml

.Beispiel web.xml
====
[source,json]
----
<filter>
  <filter-name>durationfilter</filter-name>
  <filter-class>com.github.kreutzr.restapifilters.durationfilter.DurationfilterFilter</filter-class>
  <init-param>
    <param-name>durationfilter.header-name</param-name>
    <param-value>x-duration</param-value>
  </init-param>
  <init-param>
    <param-name>durationfilter.active</param-name>
    <param-value>true</param-value>
  </init-param>
  <init-param>
    <param-name>durationfilter.max-length</param-name>
    <param-value>16384</param-value>
  </init-param>
</filter>

<filter-mapping>
  <filter-name>durationfilter</filter-name>
  <url-pattern>/*</url-pattern>
</filter-mapping>
----
====

[NOTE]
====
* `durationfilter.header-name`: Der Name des Response-Headers kann mittels dieses Schlüssels verändert werden. Der Default ist "x-duration".
* `durationfilter.active`: Mit diesem Konfigurationsparameter kann der Filter ein- (`true`) bzw. ausgeschaltet (`false`) werden. Der Default ist `true`. Der Filter ist ausgeschaltet, wenn ein beliebiger Wert anders als `true` (Die Groß-Kleinschreibung ist unerheblich) angegeben wird.
* `durationfilter.max-length`: Über diesen Konfigurationsparameter kann die maximal zulässige Länge des Header-Werts angegeben werden. Der Default ist 16384 (= 16 K). Übersteigt die Länge des Response-Werts diesen Wert, so wird der letzte Eintrag der `trace`-Liste entfernt.
====


==== SpringBoot 3

...




